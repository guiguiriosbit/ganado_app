<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gestión Ganadera</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">

  
</head>
<body class="container py-4">
  <header class="text-center mb-4">
    <h1 class="fw-bold text-success">🐂 Gestión Ganadera</h1>
    <p class="lead text-muted">Panel administrativo de ganado</p>
  </header>

  <!-- Vista móvil inicial -->
    <div class="row g-3 text-center mb-4">
      <div class="col-6">
        <a href="#registroForm" class="btn btn-success w-100 py-3">
          📥<br><strong>Nuevo Registro</strong>
        </a>
      </div>
      <div class="col-6">
        <a href="#registrosTabla" class="btn btn-outline-success w-100 py-3">
          📊<br><strong>Ver Registros</strong>
        </a>
      </div>
      <div class="col-12 mt-2">
        <a href="#resumenSocios" class="btn btn-secondary w-100 py-2">
          📋 Resumen por Socio
        </a>
      </div>
    </div>

    <!-- REGISTRO DEL SOCIO -->

      <div class="card shadow-sm mb-4 border-0">
  <div class="card-header d-flex justify-content-between align-items-center"
       style="background-color: #6E7D5D; color: white; cursor: pointer;"
       onclick="toggleFormSocio()">
    <h5 class="mb-0">Nuevo Socio</h5>
    <span id="toggleIcon" style="font-size: 1.4rem;">➕</span>
  </div>

  <div id="formSocio" class="card-body bg-light" style="display: none;">
    <form method="POST" action="/crear_socio" class="row g-3">
      <div class="col-md-6">
        <label class="form-label text-muted">Nombre del Socio</label>
        <input type="text" style="text-transform: uppercase;" name="nombre" class="form-control border-success"
               placeholder="Ej: Agropecuaria El Prado" required>
      </div>

      <div class="col-12 text-end">
        <button type="submit" class="btn"
                style="background-color: #6E7D5D; color: white;">✅ Registrar</button>
      </div>
    </form>
  </div>
</div>
          


    <!-- FORMULARIO DE REGISTROS -->
    <div class="card-body" style="background-color: #cce4cc; padding:10px; border: 3px solid rgb(221, 218, 218); ">
      <form id="registroForm" method="POST" class="row g-3">

        <div class="col-12 col-md-3">
          <label class="form-label">Fecha</label>
          <input type="date" name="fecha" class="form-control" required>
        </div>

        <div class="col-12 col-md-3">
          <label class="form-label">Socio</label>
          <select name="socio_id" class="form-select" onchange="filtrarPorSocio(this.value)" required>
            <option value="">Selecciona un socio</option>
            {% for socio in socios %}
              <option value="{{ socio.id }}" {% if request.args.get('socio_id') == socio.id %}selected{% endif %}>{{ socio.nombre }}</option>
            {% endfor %}
          </select>
          
        </div>

        <div class="col-12 col-md-3">
          <label class="form-label">Cantidad 🐄</label>
          <input type="number" name="cantidad" id="cantidadPrincipal" class="form-control cantidad-clickable" readonly onclick="abrirPopupGanado()" required>
          <small class="text-muted">🔢 Se calcula automáticamente desde el desglose por tipo</small>
        </div>

        <!-- Popup tipos -->
        <div class="modal fade" id="popupGanado" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-lg">
            <div class="modal-content border-success">
              <div class="modal-header bg-olivo text-white">
                <h5 class="modal-title">🐄 Detalle por tipo de ganado</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
              </div>

              <div class="modal-body">
                <table class="table table-bordered">
                  <thead>
                    <tr>
                      <th>Tipo</th>
                      <th>Cantidad</th>
                      <th>Notas</th>
                      <th>Acción</th>
                    </tr>
                  </thead>
                  <tbody id="tablaTipos">
                    <tr>
                      <td>
                        <select class="form-select tipo_id" name="tipo_id[0]" required>
                          {% for tipo in tipos_catalogo %}
                            <option value="{{ tipo.id }}">{{ tipo.nombre }}</option>
                          {% endfor %}
                        </select>
                      </td>
                      <td>
                        <input type="number" name="cantidad_tipo[0]" class="form-control cantidad_tipo" required>
                      </td>
                      <td>
                        <input type="text" name="nota_tipo[0]" class="form-control nota_tipo">
                      </td>
                      <td>
                        <button type="button" class="btn btn-danger btn-sm" onclick="eliminarFila(this)">🗑️</button>
                      </td>
                    </tr>
                  </tbody>
                </table>

                <button type="button" class="btn btn-success mt-3" onclick="agregarFila()">➕ Agregar tipo</button>
                <button type="button" class="btn btn-success mt-3" onclick="actualizarCantidad()">✅ Agregar Cantidad</button>

                <p class="mt-2 text-muted" id="validacionCantidad"></p>
                <p class="mt-2 text-success fw-bold" id="resumenTiposGanado"></p>
              </div>

              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
              </div>
            </div>
          </div>
        </div>

        <br/>
        <!-- Campos finales -->
        <div class="col-12 col-md-2">
          <label class="form-label">Kg/Totales </label>
          <input type="number" step="any" name="kg_totales" class="form-control" required>
        </div>
        <div class="col-12 col-md-2">
          <label class="form-label">Valor Kilo 💰</label>
          <input type="number" step="any" name="vr_kilo" class="form-control" required>
        </div>
        <div class="col-12 col-md-2">
          <label class="form-label">Fletes 🚛</label>
          <input type="number" step="any" name="fletes" class="form-control" required>
        </div>
        <div class="col-12 col-md-2">
          <label class="form-label">Comisión 📎</label>
          <input type="number" step="any" name="comision" class="form-control" required>
        </div>
        <div class="d-grid gap-2 mt-3">
          <button class="btn btn-success" onclick="guardarRegistro()">💾 Guardar registro</button>
        </div>

      </form>
    </div>
  </div>
  <br/>
  <h2 class="mb-3 text-success">📊 Registros</h2>
  <div class="table-responsive excel-style">
    {{ table|safe }}
  </div>
  <br/>
  <div class="row">
  {% for resumen in resumenes %}
    <div class="col-12 mb-4">
      <div class="row g-3">
        
        <!-- Card del resumen -->
        <div class="col-12 col-md-6">
          <div class="card h-100 border-success shadow-sm">
            <div class="card-header bg-olivo text-white">
              <h5 class="card-title">📋 Socio: {{ resumen.nombre }}</h5>
            </div>
            <div class="card-body">
              <p>🐄 Animales: <strong>{{ resumen.cantidad }}</strong></p>
              <p>💰 Ingresos: <strong>${{ "{:,.0f}".format(resumen.ingresos) }}</strong></p>
              <p>🛒 Ventas: <em>Pendiente</em></p>
            </div>
          </div>
        </div>

        <!-- Card del desglose -->
        <div class="col-12 col-md-6">
          <div class="card h-100 border-success shadow-sm">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
              <span>Desglose Tipo Ganado</span>
              <i class="bi bi-bar-chart-line-fill"></i>
            </div>
            <div class="card-body">
              {% if resumen.desglose %}
                <ul class="list-group mb-2">
                  {% for item in resumen.desglose %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                      <div>
                        {% if item.tipo == 'Bovino' %}🐄
                        {% elif item.tipo == 'Porcino' %}🐖
                        {% elif item.tipo == 'Caprino' %}🐐
                        {% else %}🐾
                        {% endif %}
                        <strong>{{ item.tipo }}</strong>
                      </div>
                      <span class="badge bg-secondary rounded-pill">{{ item.cantidad }}</span>
                    </li>
                  {% endfor %}
                </ul>
                <div class="text-end">
                  <strong>Total:</strong>
                  <span class="badge bg-dark rounded-pill">
                    {{ resumen.desglose | sum(attribute='cantidad') }}
                  </span>
                </div>
              {% else %}
                <p class="text-muted">Sin desglose registrado.</p>
              {% endif %}
            </div>
          </div>
        </div>

      </div>
    </div>
  {% endfor %}
</div>



</div>
     
</div>

  <script>
  function toggleFormSocio() {
    const form = document.getElementById("formSocio");
    const icon = document.getElementById("toggleIcon");
    const visible = form.style.display === "block";
    form.style.display = visible ? "none" : "block";
    icon.textContent = visible ? "➕" : "✖️";
  }
</script>

  <script>
    function guardarRegistro() {
    const fecha = document.getElementById('fecha').value;
    const socio = document.getElementById('socio').value;
    const cantidad = document.getElementById('cantidadPrincipal').value;
    const totalKg = document.getElementById('kgTotal').value;
    const valorKilo = document.getElementById('valorKilo').value;
    const fletes = document.getElementById('fletes').value;
    const comision = document.getElementById('comision').value;

    // Aquí iría tu lógica: enviar a Supabase, mostrar resumen, etc.
    console.log({ fecha, socio, cantidad, totalKg, valorKilo, fletes, comision });

    alert('✅ Registro guardado exitosamente');
  }

  </script>

  <script src="https://cdn.jsdelivr.net/npm/  bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js">

  </script>
  <script>
    function abrirPopupGanado() {
      const modal = new bootstrap.Modal(document.getElementById("popupGanado"));
      modal.show();
    }

    function agregarFila() {
      const index = document.querySelectorAll(".tipo_id").length;
      const tipos = `{% for tipo in tipos_catalogo %}<option value="{{ tipo.id }}">{{ tipo.nombre }}</option>{% endfor %}`;
      const fila = `
        <tr>
          <td><select class="form-select tipo_id" name="tipo_id[${index}]" required>${tipos}</select></td>
          <td><input type="number" name="cantidad_tipo[${index}]" class="form-control cantidad_tipo" required></td>
          <td><input type="text" name="nota_tipo[${index}]" class="form-control nota_tipo"></td>
          <td><button type="button" class="btn btn-danger btn-sm" onclick="eliminarFila(this)">🗑️</button></td>
        </tr>`;
      document.getElementById("tablaTipos").insertAdjacentHTML("beforeend", fila);
    }

    function eliminarFila(btn) {
      btn.closest("tr").remove();
      validarCantidad();
    }

    function validarCantidad() {
      const tipos = document.querySelectorAll(".cantidad_tipo");
      let total = 0;
      tipos.forEach(input => total += parseInt(input.value || 0));
      document.getElementById("cantidadPrincipal").value = total;

      const mensaje = document.getElementById("validacionCantidad");
      const btn = document.getElementById("btnGuardar");

      if (total > 0) {
        mensaje.innerHTML = `✅ Total por tipo: ${total} animales`;
        btn.disabled = false;
      } else {
        mensaje.innerHTML = `❌ La cantidad debe ser mayor a cero`;
        btn.disabled = true;
      }

      actualizarResumenDesglose();
    }

    function actualizarResumenDesglose() {
  const filas = document.querySelectorAll("#tablaTipos tr");
  let resumen = [];
  let total = 0;
  filas.forEach(fila => {
    const select = fila.querySelector(".tipo_id");
    const tipoTexto = select ? select.options[select.selectedIndex].text : "";
    const cantidad = parseInt(fila.querySelector(".cantidad_tipo")?.value || 0);
    if (tipoTexto && cantidad > 0) {
      resumen.push(`${tipoTexto} (${cantidad})`);
      total += cantidad;
    }
  });
  const resumenTexto = resumen.length > 0
    ? `➕ ${resumen.join(", ")} → Total: ${total} animales`
    : "";
  document.getElementById("resumenTiposGanado").innerText = resumenTexto;
}

document.getElementById("tablaTipos").addEventListener("input", validarCantidad);

function filtrarPorSocio(socioId) {
  if (socioId) {
    window.location.href = `/?socio_id=${socioId}`;
  } else {
    window.location.href = "/";
  }
}
  </script>
  <script>
      function actualizarCantidad() {
          let total = 0;
          document.querySelectorAll('.cantidad_tipo').forEach(input => {
             const cantidad = parseInt(input.value);
            if (!isNaN(cantidad)) {
              total += cantidad;
            }
          });

          document.getElementById('cantidadPrincipal').value = total;
          document.getElementById('resumenTiposGanado').textContent = `🐄 Total ganado: ${total}`;

          const modal = bootstrap.Modal.getInstance(document.getElementById('popupGanado'));
          modal.hide();
        }
      </script>

      <!-- Scripts de Bootstrap (si no los tienes ya) -->
      {% block scripts %}
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
      {% endblock %}
      <script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  const supabase = createClient(
    'https://skukbqfhreogredrjwdq.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNrdWticWZocmVvZ3JlZHJqd2RxIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1Mjg0OTc1OCwiZXhwIjoyMDY4NDI1NzU4fQ.DF6KOW1Krc1zBPVzT80IWbzrkaOCqELnhB7totTP9ZA'
  );

  async function guardarRegistro() {
    try {
      const fecha = document.querySelector('[name="fecha"]').value;
      const socio_id = document.querySelector('[name="socio_id"]').value;
      const cantidad = parseInt(document.querySelector('#cantidadPrincipal').value || 0);
      const kg_totales = parseFloat(document.querySelector('[name="kg_totales"]').value || 0);
      const vr_kilo = parseFloat(document.querySelector('[name="vr_kilo"]').value || 0);
      const fletes = parseFloat(document.querySelector('[name="fletes"]').value || 0);
      const comision = parseFloat(document.querySelector('[name="comision"]').value || 0);

      const total = (kg_totales * vr_kilo) + fletes + comision;

      // 1. Insertar registro principal
      const { data: registroData, error: registroError } = await supabase
        .from("registros")
        .insert([{
          fecha,
          socio_id,
          cantidad,
          kg_totales,
          vr_kilo,
          fletes,
          comision,
          total
        }])
        .select();

      if (registroError || !registroData?.length) {
        alert("❌ Error al guardar registro principal");
        console.error(registroError);
        return;
      }

      const registro_id = registroData[0].id;

      // 2. Preparar desglose
      const filas = document.querySelectorAll("#tablaTipos tr");
      const desglose = [];

      filas.forEach((fila, index) => {
        const tipo_id = fila.querySelector(".tipo_id")?.value;
        const cantidad_tipo = parseInt(fila.querySelector(".cantidad_tipo")?.value || 0);
        const notas = fila.querySelector(".nota_tipo")?.value || "";

        if (tipo_id && cantidad_tipo > 0) {
          desglose.push({
            registro_id,
            socio_id,
            tipo_id,
            cantidad: cantidad_tipo,
            notas
          });
        }
      });

      // 3. Insertar desglose en tipo_ganado
      if (desglose.length > 0) {
        const { error: desgloseError } = await supabase
          .from("tipo_ganado")
          .insert(desglose);

        if (desgloseError) {
          alert("❌ Error al guardar desglose");
          console.error(desgloseError);
          return;
        }
      }

      // 4. Feedback y recarga
      alert("✅ Registro guardado exitosamente");
      window.location.reload();

    } catch (err) {
      console.error("⚠️ Error inesperado:", err);
      alert("❌ Error inesperado");
    }
  }

  // Reemplaza el onclick inline por este binding
  document.querySelector('button.btn-success').addEventListener('click', (e) => {
    e.preventDefault();
    guardarRegistro();
  });
</script>


</body>
</html>







